#Seuratのチュートリアルでセットアップを行う。
library(dplyr)
library(patchwork)
library(Seurat)
library(cowplot)
library(ggplot2)
#公共データをダウンロードしておく
ctrl.data <- Read10X(data.dir = "C:/Users/Keisu/Desktop/GSE276809_Akiyama_scRNA-seq/GSM8506100_WT_CTL")
ab.data <- Read10X(data.dir = "C:/Users/Keisu/Desktop/GSE276809_Akiyama_scRNA-seq/GSM8506103_CD40_RL_Ab")

ctrl <- CreateSeuratObject(counts = ctrl.data, project = "IMMUNE_CTRL", min.cells = 5)
ctrl$ab <- "CTRL"
ctrl <- subset(ctrl, subset = nFeature_RNA > 500)
ctrl <- NormalizeData(ctrl, verbose = FALSE)
ctrl <- FindVariableFeatures(ctrl, selection.method = "vst", nfeatures = 2000)

ab <- CreateSeuratObject(counts = ab.data, project = "IMMUNE_AB", min.cells = 5)
ab$ab <- "AB"
ab <- subset(ab, subset = nFeature_RNA > 500)
ab <- NormalizeData(ab, verbose = FALSE)
ab <- FindVariableFeatures(ab, selection.method = "vst", nfeatures = 2000)

immune.anchors <- FindIntegrationAnchors(object.list = list(ctrl, ab), dims = 1:20)
immune.combined <- IntegrateData(anchorset = immune.anchors, dims = 1:20)


DefaultAssay(immune.combined) <- "integrated"

# Run the standard workflow for visualization and clustering
immune.combined <- ScaleData(immune.combined, verbose = FALSE)
immune.combined <- RunPCA(immune.combined, npcs = 30, verbose = FALSE)
# t-SNE and Clustering
immune.combined <- RunUMAP(immune.combined, reduction = "pca", dims = 1:20)
immune.combined <- FindNeighbors(immune.combined, reduction = "pca", dims = 1:20)
immune.combined <- FindClusters(immune.combined, resolution = 0.5)

# Visualization
p1 <- DimPlot(immune.combined, reduction = "umap", group.by = "ab")
p2 <- DimPlot(immune.combined, reduction = "umap", label = TRUE)
plot_grid(p1, p2)

DimPlot(immune.combined, reduction = "umap", split.by = "ab")
#保存された細胞型マーカーを特定する
DefaultAssay(immune.combined) <- "RNA"
claster7.markers <- FindConservedMarkers(immune.combined, ident.1 = 7, grouping.var = "ab", verbose = FALSE)
head(claster7.markers)
#7→"クラスタ名(_AB or _CTRL)" 分からないときはtable(immune.combined$ab, Idents(immune.combined))で確認

#マーカー遺伝子を調査し、それらを使用してクラスターを特定の細胞タイプとして注釈付け
FeaturePlot(immune.combined, features = c("Epcam","Aire","Ciita","Pecam1","Enpep","Ptprc","Pdpn","Dpp4","Ccl21a","Ascl1","Utf1","Trpm5","psmb11","Fos","Scn1a","Serpinf1","Sox8","Cdh5","Kdr"), min.cutoff = "q9")
#例
FeaturePlot(immune.combined, features = c("Epcam","Spp1","Ciita","Pecam1","Enpep","Ptprc","Pdpn","Dpp4","Ccl21a"), min.cutoff = "q9")
#クラスタに名前つけ
immune.combined <- RenameIdents(immune.combined, `0` = "Mature mTEC", `1` = "Aire+ mTEC", `2` = "post mTEC", `3` = "proliferating cell", `4` = "Ccl21 + mTEC_1", `5` = "Ccl21 + mTEC_2", `6` = "Epithelial cells", `7` = "Tuft cell", `8` = "cTEC", `9` = "Ccl21 + mTEC_3",`10` = "Ccl21 + mTEC_4", `11` = "Nerve cells +  Bone related cells", `12` = "CD8Tcells", `13` = "Microfold cells",'14' = "Testis related cells + Immature lymphoma", '15' = "Ciliated cells", '16' = "Vascular endothelial cells")
DimPlot(immune.combined, label = TRUE)

Idents(immune.combined) <- factor(Idents(immune.combined), levels = c("Mature mTEC", "Aire+ mTEC", "post mTEC",  "proliferating cell",  "Ccl21 + mTEC_1",  "Ccl21 + mTEC_2",  "Epithelial cells",  "Tuft cell", "cTEC", "Ccl21 + mTEC_3", "Ccl21 + mTEC_4",  "Nerve cells",  "CD8Tcells","Microfold cells", "Testis related cell + Immature lymphoma", "Ciliated cells",  "Vascular endothelial cells"))

markers.to.plot <- c("Epcam","Aire","Ciita","Pecam1","Enpep","Ptprc","Pdpn","Spp1","Ccl21a","Ascl1","Utf1","Trpm5","psmb11","Fos","Scn1a","Serpinf1","Sox8","Cdh5","FoxA","Myog","Grhl","SpiB","Hnf4","Pou2f3","Foxj1")

DotPlot(immune.combined, features = rev(markers.to.plot), cols = c("blue", "red"), dot.scale = 8, 
    split.by = "ab") + RotatedAxis()


#様々な条件で発現する遺伝子を確認する。
DimPlot(immune.combined, label = TRUE)
mature.mTEC <- subset(immune.combined, idents = "Mature mTEC")
Idents(mature.mTEC) <- "ab"
avg.mature.mTEC <- log1p(AverageExpression(mature.mTEC, verbose = FALSE)$RNA)
avg.mature.mTEC$gene <- rownames(avg.mature.mTEC)
ccl21.mTEC2 <- subset(immune.combined, idents = "Ccl21 + mTEC_2")
Idents(ccl21.mTEC2) <- "ab"
avg.ccl21.mTEC2 <- log1p(AverageExpression(ccl21.mTEC2, verbose = FALSE)$RNA)
avg.ccl21.mTEC2$gene <- rownames(avg.ccl21.mTEC2)

genes.to.label = c("Xkr4","Mrpl15","Lypla1","Tcea1","Rgs20","Atp6v1h")
p1 <- ggplot(avg.mature.mTEC, aes(CTRL, AB)) + geom_point() + ggtitle("Mature mTEC")
p1 <- LabelPoints(plot = p1, points = genes.to.label, repel = TRUE)
p2 <- ggplot(avg.ccl21.mTEC2, aes(CTRL, AB)) + geom_point() + ggtitle("Ccl21 + mTEC_2")
p2 <- LabelPoints(plot = p2, points = genes.to.label, repel = TRUE)
plot_grid(p1, p2)

# Create a new identifier combining cell type and stimulation status
immune.combined$celltype.ab <- paste(Idents(immune.combined), immune.combined$ab, sep = "_")

# Backup current cell type identifiers and update to the new combined identifier
immune.combined$celltype <- Idents(immune.combined)
Idents(immune.combined) <- "celltype.ab"
table(immune.combined$celltype.ab)
# Identify genes differentially expressed between stimulated and control B cells
b.interferon.response <- FindMarkers(immune.combined, ident.1 = "Aire+ mTEC_AB", ident.2 = "Aire+ mTEC_CTRL", verbose = FALSE)
#エラー出たら
immune.combined <- JoinLayers(immune.combined)
immune.combined@assays
DefaultAssay(immune.combined) <- "integrated"
# 正しいクラスタ名を指定(再度)
> b.interferon.response <- FindMarkers(immune.combined, ident.1 = "Aire+ mTEC_AB", ident.2 = "Aire+ mTEC_CTRL", verbose = FALSE)
#b.inter...名前は適当をクリックして有意差のある遺伝子をメモ

# Visualize expression of selected genes split by stimulation statusメモした遺伝子名を入れる
FeaturePlot(immune.combined, features = c("Ednrb", "Fbxl22", "Ccl3"), split.by = "ab", max.cutoff = 3, cols = c("grey", "red"))
﻿＃バイオリンプロット
plots <- VlnPlot(immune.combined, features = c("Tnfrsf8", "Fas", "Epcam"), split.by = "ab", group.by = "celltype",
                 pt.size = 0, combine = FALSE)

# Display the generated plots in a single column layout
wrap_plots(plots = plots, ncol = 1)
